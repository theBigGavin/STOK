# 集成测试运行器 Dockerfile
# 用于运行集成测试的专用容器

FROM node:18-alpine

WORKDIR /app

# 安装系统依赖
RUN apk add --no-cache \
    curl \
    postgresql-client \
    && rm -rf /var/cache/apk/*

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制应用代码
COPY . .

# 创建测试结果目录
RUN mkdir -p /app/test-results

# 设置环境变量
ENV NODE_ENV=test
ENV TEST_TIMEOUT=120000

# 健康检查脚本
COPY frontend/tests/integration/wait-for-services.sh /app/wait-for-services.sh
RUN chmod +x /app/wait-for-services.sh

# 默认命令 - 等待服务就绪后运行测试
CMD ["/app/wait-for-services.sh", "test-backend:8000", "test-frontend:5173", "test-database:5432", "test-redis:6379", "&&", "npm", "run", "test:integration:ci"]